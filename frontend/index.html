<!DOCTYPE html>
<html>
<head>
  <title>Send Emails with PDF</title>
</head>
<body>
  <h2>Upload Excel & PDF to Send Emails</h2>
  <form id="uploadForm">
    <label>Select Excel File (.xlsx):</label><br>
    <input type="file" name="excel" accept=".xlsx" required><br><br>

    <label>Select PDF File:</label><br>
    <input type="file" name="pdf" accept=".pdf" required><br><br>

    <button type="submit">Send Emails</button>
  </form>

  <p id="status"></p>

  <script>
    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      document.getElementById('status').textContent = 'Sending emails...';

      try {
        const res = await fetch('const express = require('express');
const multer = require('multer');
const xlsx = require('xlsx');
const nodemailer = require('nodemailer');
const cors = require('cors');
const fs = require('fs');
require('dotenv').config();

const app = express();

// Enable CORS for all origins (you can restrict this later)
app.use(cors({ origin: '*' }));

const PORT = process.env.PORT || 5000;

// Configure Multer for file uploads
const upload = multer({ dest: 'uploads/' });

// API Endpoint: Upload Excel + PDF and send emails
app.post('/send-emails', upload.fields([{ name: 'excel' }, { name: 'pdf' }]), async (req, res) => {
  try {
    const excelFile = req.files?.excel?.[0];
    const pdfFile = req.files?.pdf?.[0];

    if (!excelFile || !pdfFile) {
      return res.status(400).send('Both Excel and PDF files are required.');
    }

    // Read Excel file
    const workbook = xlsx.readFile(excelFile.path);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const data = xlsx.utils.sheet_to_json(sheet);

    // Read PDF file as buffer
    const pdfBuffer = fs.readFileSync(pdfFile.path);

    // Setup email transporter (using environment variables)
    const transporter = nodemailer.createTransport({
      service: 'gmail',
      auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASS,
      },
    });

    // Email content template
    const emailTemplate = ({ name, company }) => `
      Hi ${name},

      I'm Mahesh Boopathi, a full-stack developer with hands-on experience in React, Spring Boot, PostgreSQL, and AWS.

      I've been following ${company} and really admire the work your team is doing. Iâ€™d love the opportunity to contribute and grow alongside you.

      Hereâ€™s why I believe we should connect:
      - I build fast, scalable, and maintainable full-stack applications.
      - I stay up to date with the latest trends in web development.
      - Iâ€™m passionate about solving real-world problems through clean code and collaboration.

      I've attached my resume for your reference. Iâ€™d be thrilled to connect and explore how I can bring value to ${company}.

      Looking forward to hearing from you.

      Warm regards,
      Mahesh Boopathi
    `;

    // Loop through each email address in Excel
    for (const row of data) {
      const email = row.Email || row.email;
      if (!email) continue;

      const [namePart, domainPart] = email.split('@');
      const name = namePart.charAt(0).toUpperCase() + namePart.slice(1);
      const company = domainPart.split('.')[0];

      const mailText = emailTemplate({ name, company });

      console.log(`Sending email to: ${email}`);

      await transporter.sendMail({
        from: process.env.EMAIL_USER,
        to: email,
        subject: `Full-Stack Developer Interested in Joining ${company}`,
        text: mailText,
        attachments: [
          {
            filename: 'Mahesh_Boopathi_CV.pdf',
            content: pdfBuffer,
          },
        ],
      });
    }

    // Clean up uploaded files
    fs.unlinkSync(excelFile.path);
    fs.unlinkSync(pdfFile.path);

    res.send('âœ… Emails sent successfully!');
  } catch (err) {
    console.error('Error:', err);
    res.status(500).send('âŒ Error sending emails.');
  }
});

// Start the backend server
app.listen(PORT, () => console.log(`ðŸš€ Backend running on port ${PORT}`));
', {
          method: 'POST',
          body: formData
        });

        const text = await res.text();
        document.getElementById('status').textContent = text;
      } catch (err) {
        document.getElementById('status').textContent = 'Failed to send emails.';
        console.error(err);
      }
    });
  </script>
</body>
</html>
